name: Run switched packages content validation
trigger: none

parameters:
- name: packages
  displayName: |
      Comma-delimited list of packages to test against (by default, 'all' to run all). Example: 'azure-appconfiguration, azure-keyvault-keys'
  type: string
  default: 'all'
- name: isFirstRun
  displayName: |
      If it is the first run of this pipeline, set this param as true. It's a condition of whether download the last pipeline artifacts. Default is: 'false'
  type: string
  default: 'false'

stages:
- stage: ContentValidationTesting
  jobs:
  - ${{ each packageName in split(parameters.packages, ',') }}:
    - ${{ if ne(parameters.packages, 'all') }}:
      - template: /eng/pipelines/package/${{ packageName }}.yml
        parameters:
          GitHubPat: $(GITHUB_PAT)
          GitHubOwner: $(GITHUB_OWNER)
          GitHubRepo: $(GITHUB_REPO)
          IsFirstRun: ${{ parameters.isFirstRun }}

  - ${{ if eq(parameters.packages, 'all') }}:
    - template: /eng/pipelines/package/run-all-packages.yml
      parameters:
        GitHubPat: $(GITHUB_PAT)
        GitHubOwner: $(GITHUB_OWNER)
        GitHubRepo: $(GITHUB_REPO)
        IsFirstRun: ${{ parameters.isFirstRun }}

- stage: TotalIssuesSummary
  dependsOn: ContentValidationTesting
  jobs:
  - job: Maintain_Total_Issues_List
    displayName: Maintain_Total_Issues_List
    pool:
      vmImage: ubuntu-latest
    steps:
    - task: DotNetCoreCLI@2
      displayName: Build issuer helper project
      inputs:
        command: 'build'
        projects: 'IssuerHelper/IssuerHelper.csproj'

    - task: DotNetCoreCLI@2
      displayName: Summary Total Issues of all packages
      inputs:
        command: 'run'
        workingDirectory: '$(System.DefaultWorkingDirectory)/IssuerHelper'

    - task: PublishPipelineArtifact@1
      displayName: "Upload pipeline test data"
      inputs:
        targetPath: $(System.DefaultWorkingDirectory)/ReportsTest
        artifactName: history-issues-summary
        publishLocation: "pipeline"